<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§„í–‰ ì¤‘ì¸ íšŒì˜</title>
    <link rel="stylesheet" href="/css/meeting-list.css">
</head>
<body>
<div class="container">
    <header class="meeting-header">
        <h1>ì§„í–‰ ì¤‘ì¸ íšŒì˜</h1>
        <button class="btn btn-primary" onclick="window.location.href='/meeting/setup'">
            ìƒˆ íšŒì˜ ì‹œì‘
        </button>
    </header>

    <div class="meeting-grid" id="meetingGrid">
        <!-- íšŒì˜ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>

    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">ğŸ“¹</div>
        <h2>ì§„í–‰ ì¤‘ì¸ íšŒì˜ê°€ ì—†ìŠµë‹ˆë‹¤</h2>
        <p>ìƒˆë¡œìš´ íšŒì˜ë¥¼ ì‹œì‘í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì‚¬ëŒì´ ì‹œì‘í•œ íšŒì˜ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>
</div>

<!-- Token.js ë¨¼ì € ë¡œë“œ (íŒŒì¼ëª… ëŒ€ì†Œë¬¸ì ì£¼ì˜!) -->
<script src="/js/Token.js"></script>

<script>
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ID ê°€ì ¸ì˜¤ê¸° (workspaceCdë¡œ í†µì¼)
    const urlParams = new URLSearchParams(window.location.search);
    const workspaceId = urlParams.get('workspaceCd') || urlParams.get('workspaceId');

    if (!workspaceId) {
        console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ IDê°€ ì—†ìŠµë‹ˆë‹¤');
        alert('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        window.history.back();
    }

    // í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const userInfo = getUserInfoFromToken();
    const currentUserId = userInfo?.userId;

    // ì§„í–‰ ì¤‘ì¸ íšŒì˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function fetchActiveMeetings() {
        try {
            console.log('ì§„í–‰ ì¤‘ì¸ íšŒì˜ ëª©ë¡ ì¡°íšŒ ì¤‘... workspaceId:', workspaceId);

            // apiRequest í•¨ìˆ˜ ì‚¬ìš© (token.jsì— ì •ì˜ë¨)
            const response = await apiRequest(`/api/meetings/active?workspaceId=${workspaceId}`);

            if (!response.ok) {
                console.error('API ì‘ë‹µ ì—ëŸ¬:', response.status);
                return;
            }

            const meetings = await response.json();
            console.log('ì¡°íšŒëœ íšŒì˜ ëª©ë¡:', meetings);

            displayMeetings(meetings);
        } catch (error) {
            console.error('íšŒì˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
            // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¹ˆ ëª©ë¡ í‘œì‹œ
            displayMeetings([]);
        }
    }

    // íšŒì˜ ëª©ë¡ í‘œì‹œ
    function displayMeetings(meetings) {
        const grid = document.getElementById('meetingGrid');
        const emptyState = document.getElementById('emptyState');

        grid.innerHTML = '';

        if (!meetings || meetings.length === 0) {
            grid.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        grid.style.display = 'grid';
        emptyState.style.display = 'none';

        meetings.forEach(meeting => {
            const card = createMeetingCard(meeting);
            grid.appendChild(card);
        });
    }

    // íšŒì˜ ì¹´ë“œ ìƒì„±
    function createMeetingCard(meeting) {
        const card = document.createElement('div');
        card.className = 'meeting-card';

        // ë‚´ê°€ ì°¸ì—¬ ì¤‘ì¸ íšŒì˜ì¸ì§€ í™•ì¸
        const isMyMeeting = meeting.participants &&
            meeting.participants.some(p => p.userId === currentUserId);
        const amIHost = meeting.hostId === currentUserId;

        if (isMyMeeting) {
            card.classList.add('your-meeting');
        }

        // ì œëª©ì—ì„œ ì‘ì€ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
        const escapedTitle = (meeting.title || 'ì œëª© ì—†ìŒ').replace(/'/g, "\\'");

        card.innerHTML = `
            <div class="meeting-status status-active">
                <span class="status-dot"></span>
                ì§„í–‰ ì¤‘
            </div>

            <h3 class="meeting-title">
                ${meeting.title || 'ì œëª© ì—†ìŒ'}
                ${amIHost ? '<span class="host-badge">í˜¸ìŠ¤íŠ¸</span>' : ''}
            </h3>

            <div class="meeting-info">
                ì‹œì‘ ì‹œê°„: ${formatTime(meeting.startTime)}
            </div>

            <div class="meeting-participants">
                <div class="participant-avatars">
                    ${createParticipantAvatars(meeting.participants || [])}
                </div>
                <span>${meeting.participantCount || 0}ëª… ì°¸ì—¬ ì¤‘</span>
            </div>

            <div class="meeting-actions">
                ${isMyMeeting ?
                    `<button class="btn btn-primary" onclick="rejoinMeeting('${meeting.roomId}', '${escapedTitle}')">
                        ë‹¤ì‹œ ì°¸ì—¬í•˜ê¸°
                    </button>` :
                    `<button class="btn btn-secondary" onclick="joinMeeting('${meeting.roomId}', '${escapedTitle}')">
                        ì°¸ì—¬í•˜ê¸°
                    </button>`
                }
                ${amIHost ?
                    `<button class="btn btn-danger" onclick="endMeeting('${meeting.roomId}')">
                        íšŒì˜ ì¢…ë£Œ
                    </button>` : ''
                }
            </div>
        `;

        return card;
    }

    // ì°¸ê°€ì ì•„ë°”íƒ€ ìƒì„±
    function createParticipantAvatars(participants) {
        const maxDisplay = 3;
        const displayParticipants = participants.slice(0, maxDisplay);

        let avatars = displayParticipants.map(p =>
            `<div class="participant-avatar" title="${p.displayName || 'ì°¸ê°€ì'}">
                ${(p.displayName || '?').charAt(0).toUpperCase()}
            </div>`
        ).join('');

        if (participants.length > maxDisplay) {
            avatars += `<div class="participant-avatar more">
                +${participants.length - maxDisplay}
            </div>`;
        }

        return avatars;
    }


async function rejoinMeeting(roomId, meetingTitle) {
    try {
        // ë¯¸ë””ì–´ ì„œë²„ URL
        const mediaServerUrl = window.location.hostname === 'localhost'
            ? 'https://localhost:3001'
            : 'https://192.168.0.16:3001';

        // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const userInfo = getUserInfoFromToken();
        console.log('ì¬ì°¸ì—¬ ì‹œ ì‚¬ìš©ì ì •ë³´:', userInfo);

        // â­ displayNameì´ ì—†ê±°ë‚˜ 'ì°¸ê°€ì'ì¸ ê²½ìš° localStorageì—ì„œ ë‹¤ì‹œ í™•ì¸
        let actualDisplayName = userInfo?.userName;
        if (!actualDisplayName || actualDisplayName === 'ì°¸ê°€ì') {
            actualDisplayName = localStorage.getItem('userName') || userInfo?.userName || 'ì°¸ê°€ì';
        }

        // â­ userIdë„ í™•ì‹¤íˆ ê°€ì ¸ì˜¤ê¸°
        let actualUserId = userInfo?.userId;
        if (!actualUserId) {
            actualUserId = localStorage.getItem('userId') || userInfo?.userId;
        }

        console.log('ìµœì¢… ì‚¬ìš©ì ì •ë³´:', {
            userId: actualUserId,
            displayName: actualDisplayName
        });

        // í˜¸ìŠ¤íŠ¸ ìƒíƒœ ë¨¼ì € í™•ì¸
        const hostCheckResponse = await apiRequest(`/api/meetings/${roomId}/is-host`);
        let isHostUser = false;
        let hostId = null;

        if (hostCheckResponse.ok) {
            const hostData = await hostCheckResponse.json();
            isHostUser = hostData.isHost;
            hostId = hostData.hostId;
            console.log('í˜¸ìŠ¤íŠ¸ í™•ì¸ ê²°ê³¼:', hostData);
        }

        // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
        const params = new URLSearchParams({
            roomId: roomId,
            workspaceId: workspaceId,
            meetingTitle: meetingTitle || 'íšŒì˜',
            peerId: actualUserId,
            userId: actualUserId,
            displayName: actualDisplayName,  // â­ ì‹¤ì œ ì‚¬ìš©ì ì´ë¦„ ì „ë‹¬
            userProfileImg: userInfo?.userProfileImg || '',
            rejoin: 'true',
            isHost: isHostUser,  // â­ í˜¸ìŠ¤íŠ¸ ì—¬ë¶€ ì „ë‹¬
            hostId: hostId || ''
        });

        console.log('ì¬ì°¸ì—¬ URL íŒŒë¼ë¯¸í„°:', params.toString());

        // íšŒì˜ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = `${mediaServerUrl}/ocean-video-chat-complete.html?${params.toString()}`;

    } catch (error) {
        console.error('íšŒì˜ ì¬ì°¸ì—¬ ì‹¤íŒ¨:', error);
        alert('íšŒì˜ ì¬ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}


// ìƒˆë¡œìš´ íšŒì˜ ì°¸ì—¬
async function joinMeeting(roomId, meetingTitle) {
    if (confirm('ì´ íšŒì˜ì— ì°¸ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        await rejoinMeeting(roomId, meetingTitle);
    }
}

// í˜¸ìŠ¤íŠ¸ í‘œì‹œë¥¼ ìœ„í•œ íšŒì˜ ì¹´ë“œ ë Œë”ë§ ê°œì„ 
function renderMeetingCard(meeting) {
    const isHost = meeting.hostId === currentUserId;  // í˜„ì¬ ì‚¬ìš©ìê°€ í˜¸ìŠ¤íŠ¸ì¸ì§€ í™•ì¸

    return `
        <div class="meeting-card">
            <div class="meeting-header">
                <h3>${meeting.meetingTitle}</h3>
                ${isHost ? '<span class="host-badge">í˜¸ìŠ¤íŠ¸</span>' : ''}
            </div>
            <div class="meeting-info">
                <p>ì‹œì‘ ì‹œê°„: ${formatTime(meeting.actualStartTime)}</p>
                <p>ì°¸ê°€ì: ${meeting.participantCount}ëª…</p>
                <p>í˜¸ìŠ¤íŠ¸: ${meeting.hostName}</p>
            </div>
            <div class="meeting-participants">
                ${createParticipantAvatars(meeting.participants)}
            </div>
            <div class="meeting-actions">
                <button onclick="rejoinMeeting('${meeting.roomId}', '${meeting.meetingTitle}')"
                        class="btn btn-primary">
                    íšŒì˜ ì°¸ì—¬
                </button>
                ${isHost ? `
                    <button onclick="endMeeting('${meeting.roomId}')"
                            class="btn btn-danger">
                        íšŒì˜ ì¢…ë£Œ
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

    // íšŒì˜ ì¢…ë£Œ (í˜¸ìŠ¤íŠ¸ë§Œ)
    async function endMeeting(roomId) {
        if (!confirm('ì •ë§ë¡œ íšŒì˜ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì°¸ê°€ìê°€ íšŒì˜ì—ì„œ ë‚˜ê°€ê²Œ ë©ë‹ˆë‹¤.')) {
            return;
        }

        try {
            const response = await apiRequest(`/api/meetings/${roomId}/end`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                alert('íšŒì˜ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchActiveMeetings(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } else {
                alert('íšŒì˜ ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('íšŒì˜ ì¢…ë£Œ ì‹¤íŒ¨:', error);
            alert('íšŒì˜ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì‹œê°„ í¬ë§·íŒ…
    function formatTime(timestamp) {
        if (!timestamp) return 'ì‹œê°„ ì •ë³´ ì—†ìŒ';

        const date = new Date(timestamp);
        return date.toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ íšŒì˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
        fetchActiveMeetings();

        // 5ì´ˆë§ˆë‹¤ íšŒì˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        setInterval(fetchActiveMeetings, 5000);
    });
</script>
</body>
</html>