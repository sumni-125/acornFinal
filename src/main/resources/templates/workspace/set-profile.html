<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”„ë¡œí•„ ì„¤ì • | Ocean WorkSpace</title>
  <link rel="stylesheet" th:href="@{/css/Header.css}">
  <link rel="stylesheet" th:href="@{/css/setProfile.css}">
  <!-- <link rel="stylesheet" href="/src/main/resources/static/css/Header.css">
  <link rel="stylesheet" href="/src/main/resources/static/css/setProfile.css">
  -->
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
  <!-- â­ Ocean Background CSS ì¶”ê°€ -->
  <link rel="stylesheet" th:href="@{/css/ocean-background.css}">

  <style>
    .swiper-container {
     width: 100%;
     height: 70vh;
     overflow: hidden;
 }
 .swiper-wrapper {
     width: 100%;
     height: 100%;
 }
 .swiper-slide {
     width: 100%;
     height: 100%;
     padding: 20px;
     top: 0;
     left: 0;
     transition: opacity 0.3s ease, visibility 0.3s ease;
 }
  </style>
</head>
<body>
<header class="header">
  <div class="logo" th:onclick="'location.href=\'' + @{/} + '\''">
    <div class="logo-icon">
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 50 Q30 20 50 30 T90 20" stroke="#4facfe" stroke-width="8" fill="none" stroke-linecap="round"/>
        <path d="M10 70 Q30 40 50 50 T90 40" stroke="#00f2fe" stroke-width="8" fill="none" stroke-linecap="round"/>
      </svg>
    </div>
    Ocean WorkSpace
  </div>
</header>
<div class="container">

  <form th:action="@{'/api/workspaces/' + ${workspaceCd} + '/set-profile'}" method="post" enctype="multipart/form-data">
    <!-- ğŸ”½ workspaceCd ì „ë‹¬ -->
    <input type="hidden" name="workspaceCd" th:value="${workspaceCd}">

    <div class="swiper-container">
      <div class="swiper-wrapper">
        <!-- ìŠ¬ë¼ì´ë“œ 1: ê¸°ë³¸ ì •ë³´ -->
        <div class="swiper-slide">
          <div class="profile-image">
            <img id="profilePreview" class="profile-image-preview"
                 src="data:image/svg+xml;base64,..."
                 onclick="document.getElementById('profileImage').click()">
            <input type="file" id="profileImage" name="userImg" accept="image/*">
          </div>

          <div class="form-group">
            <label for="userNickname">ë‹‰ë„¤ì„</label>
            <input type="text"
                   id="userNickname"
                   name="userNickname"
                   th:value="${member != null} ? ${member.userNickname} : ''"
                   placeholder="ì‚¬ìš©í•˜ì‹¤ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
                   required>
          </div>

          <div class="form-group">
            <label for="email">ì´ë©”ì¼</label>
            <input type="email"
                   id="email"
                   name="email"
                   th:value="${member != null} ? ${member.email} : ''"
                   placeholder="SmapleEmail@gmail.com"
                   required>
          </div>

          <div class="form-group">
            <label for="phoneNum">ì „í™”ë²ˆí˜¸</label>
            <input type="text"
                   id="phoneNum"
                   name="phoneNum"
                   th:value="${member != null} ? ${member.phoneNum} : ''"
                   placeholder="010-1234-5678">
          </div>

          <div class="form-group">
            <label for="statusMsg">ìƒíƒœ ë©”ì‹œì§€</label>
            <input type="text"
                   id="statusMsg"
                   name="statusMsg"
                   th:value="${member != null} ? ${member.statusMsg} : ''"
                   placeholder="ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          </div>

          <div class="navigation">
            <button type="button" class="btn btn-back" onclick="location.href='/workspace'">ëª©ë¡ìœ¼ë¡œ</button>
            <button type="button" class="btn btn-next" onclick="validateFirstSlide()">ë‹¤ìŒ</button>
          </div>
        </div>


        <!-- ìŠ¬ë¼ì´ë“œ 2: ë¶€ì„œ ë° ì§ê¸‰ ì •ë³´ -->
        <div class="swiper-slide">
          <h2>ì‚¬ìš© í•˜ì‹œë ¤ëŠ” ë¶€ì„œ / ê¸°ê´€ì„ ì„ íƒ í•´ ì£¼ì„¸ìš”</h2>

          <div class="form-group">
            <label for="deptCd">ë¶€ì„œ/ê¸°ê´€</label>
            <select id="deptCd" name="deptCd" required>
              <option value="">-- ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
              <option th:each="dept : ${departments}"
                      th:value="${dept.deptCd}"
                      th:text="${dept.deptNm}">
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="position">í˜„ì¬ ì§ê¸‰ì„ ì…ë ¥ í•´ì£¼ì„¸ìš”</label>
            <input type="text" id="position" name="position" placeholder="ì˜ˆ: ëŒ€ë¦¬" required>
          </div>


          <div class="navigation">
            <button type="button" class="btn btn-prev">ì´ì „ìœ¼ë¡œ</button>
            <button type="button" class="btn btn-submit" onclick="submitProfile()">ì°¸ê°€í•˜ê¸°</button>
          </div>
        </div>
      </div>

      <div class="swiper-pagination"></div>
    </div>
  </form>
</div>

<!-- â­ Ocean Background JavaScript ì¶”ê°€ -->
<script th:src="@{/js/ocean-background.js}"></script>
<script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
<script>
  let swiper;

  document.addEventListener('DOMContentLoaded', function() {
      swiper = new Swiper('.swiper-container', {
          allowTouchMove: false,
          pagination: {
              el: '.swiper-pagination',
              clickable: true,
          },
          navigation: {
              nextEl: '.btn-next',
              prevEl: '.btn-prev',
          },
          watchSlidesProgress: true,
          preventInteractionOnTransition: true,
          virtualTranslate: false,
          on: {
              init: function () {
                  console.log('Swiper initialized');
              }
          }
      });

      document.getElementById('profileImage').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
              const reader = new FileReader();
              reader.onload = function(event) {
                  document.getElementById('profilePreview').src = event.target.result;
              };
              reader.readAsDataURL(file);
          }
      });

      // âœ… ìˆ˜ì •ëœ ì²« ë²ˆì§¸ ìŠ¬ë¼ì´ë“œ ìœ íš¨ì„± ê²€ì‚¬
      window.validateFirstSlide = function() {
          const nickname = document.getElementById('userNickname').value;

          if (!nickname.trim()) {
              alert('ë‹‰ë„¤ì„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
              return;
          }

          swiper.slideNext();
      };

      document.querySelector('.btn-next').addEventListener('click', function() {
          validateFirstSlide();
      });

      document.querySelector('.btn-prev').addEventListener('click', function() {
          swiper.slidePrev();
      });

      document.querySelector('.btn-back').addEventListener('click', function() {
          location.href='/workspace';
      });

      window.addDepartment = function() {
          const section = document.getElementById('department-section');
          const div = document.createElement('div');
          div.className = 'department-input-group';

          const input = document.createElement('input');
          input.type = 'text';
          input.name = 'departments';
          input.placeholder = 'ë¶€ì„œëª…';
          input.required = true;

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'btn-remove-department';
          removeBtn.innerHTML = 'Ã—';
          removeBtn.onclick = function() { removeDepartment(this); };
          removeBtn.style.display = 'inline-block';

          div.appendChild(input);
          div.appendChild(removeBtn);
          section.appendChild(div);
      };

      window.removeDepartment = function(button) {
          const inputGroups = document.querySelectorAll('.department-input-group');
          if (inputGroups.length > 1) {
              button.parentElement.remove();
          } else {
              alert('ìµœì†Œ í•œ ê°œì˜ ë¶€ì„œëŠ” í•„ìš”í•©ë‹ˆë‹¤.');
          }
      };

      // ë‚ ì§œ í•„ë“œ ì—†ì§€ë§Œ ì•ˆì „ ì°¨ì›ì—ì„œ ìœ ì§€
      const endDateInput = document.getElementById('endDate');
      if (endDateInput) {
          endDateInput.min = new Date().toISOString().split('T')[0];
      }
  });

  function submitProfile() {
    const formData = new FormData(document.querySelector('form'));
    const workspaceCd = document.querySelector('input[name="workspaceCd"]')?.value ||
                        new URLSearchParams(window.location.search).get('workspaceCd');

    if (!workspaceCd) {
        alert('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ IDê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    fetch(`/api/workspaces/${workspaceCd}/set-profile`, {
      method: 'POST',
      body: formData
    })

    .then(res => res.json())
    .then(data => {
        if (data.redirectUrl) {
            window.location.href = data.redirectUrl;
        } else {
            alert('í”„ë¡œí•„ ì €ì¥ í›„ ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(err => {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error(err);
    });
}

</script>

</body>
</html>